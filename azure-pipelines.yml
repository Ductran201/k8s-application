# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:

  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'ghostauacr-conn'
  imageRepository: 'ksapplication'
  containerRegistry: 'ghostauacr.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'ghostauacr8f8b-auth'

  # Agent VM image name
  # vmImageName: 'ubuntu-latest'
  

stages:
- stage: Build
  displayName: Build stage
  jobs:  
  - job: Build
    displayName: Build
    pool:
      name: self-hosted-linux
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          
    - upload: manifests
      artifact: manifests

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build

  jobs:
  - job: Deploy
    displayName: Deploy
    pool:
      name: self-hosted-linux
    # environment: 'ghostinthewiresk8sapplication.myakscluster-default'

    steps:
    - task: KubernetesManifest@0
      displayName: Create imagePullSecret
      inputs:
        action: createSecret
        kubernetesServiceConnection: aks-myakscluster-conn
        secretName: $(imagePullSecret)
        dockerRegistryEndpoint: $(dockerRegistryServiceConnection)
        
    - task: KubernetesManifest@0
      displayName: Deploy to Kubernetes cluster
      inputs:
        action: deploy
        kubernetesServiceConnection: aks-myakscluster-conn
        manifests: |
          $(Pipeline.Workspace)/manifests/deployment.yml
          $(Pipeline.Workspace)/manifests/service.yml
        imagePullSecrets: |
          $(imagePullSecret)
        containers: |
          $(containerRegistry)/$(imageRepository):$(tag)

  # jobs:
  # - job: Deploy
  #   displayName: Deploy
  #   pool:
  #     vmImage: $(vmImageName)
  #   # environment: 'ghostinthewiresk8sapplication.myakscluster-default'
  #   strategy:
  #     runOnce:
  #       deploy:
  #         steps:
  #         - task: KubernetesManifest@0
  #           displayName: Create imagePullSecret
  #           inputs:
  #             action: createSecret
  #             secretName: $(imagePullSecret)
  #             dockerRegistryEndpoint: $(dockerRegistryServiceConnection)
              
  #         - task: KubernetesManifest@0
  #           displayName: Deploy to Kubernetes cluster
  #           inputs:
  #             action: deploy
  #             manifests: |
  #               $(Pipeline.Workspace)/manifests/deployment.yml
  #               $(Pipeline.Workspace)/manifests/service.yml
  #             imagePullSecrets: |
  #               $(imagePullSecret)
  #             containers: |
  #               $(containerRegistry)/$(imageRepository):$(tag)

  # jobs:
  # - job: Deploy
  #   displayName: Deploy
  #   pool:
  #     vmImage: $(vmImageName)
  #   steps:
  #   - task: KubernetesManifest@0
  #     displayName: Create imagePullSecret
  #     inputs:
  #       action: createSecret
  #       secretName: $(imagePullSecret)
  #       dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

  #   - task: KubernetesManifest@0
  #     displayName: Deploy to Kubernetes cluster
  #     inputs:
  #       action: deploy
  #       manifests: |
  #         $(Pipeline.Workspace)/manifests/deployment.yml
  #         $(Pipeline.Workspace)/manifests/service.yml
  #       imagePullSecrets: |
  #         $(imagePullSecret)
  #       containers: |
  #         $(containerRegistry)/$(imageRepository):$(tag)